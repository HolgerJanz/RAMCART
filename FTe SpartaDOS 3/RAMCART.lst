mads 2.0.9
Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/RAMCART/FTe SpartaDOS 3/RAMCART.ASM
     1 				;
     2 				; THE!RAMDISK for THE!CART for SpartaDOS 3 
     3 				; Previous work RD/RAMDISK.COM for SpartaDOS 3 by FTe
     4 				;   RD Ver 2.3 07-14-86 (c) 1984 by FTe
     5 				;
     6 				; System equates
     7 				;
     8 				; OS EQUATES
     9 				; ----------
    10 				; 
    11 				; IO EQUATES
    12 				; 
    13 = 0002			ICCOM       = $0002
    14 = 0008			ICBLL       = $0008
    15 = 0009			ICBLH       = $0009
    16 				; 
    17 				; OS VARIABLES FOR XL/XE
    18 				; 
    19 				; PAGE 0
    20 				; 
    21 = 000A			DOSVEC      = $000A
    22 = 000C			DOSINI      = $000C
    23 = 0012			RTCLOK      = $0012
    24 = 0032			BUFRLO      = $0032
    25 = 0033			BUFRHI      = $0033
    26 = 0034			BFENLO      = $0034
    27 = 0035			BFENHI      = $0035
    28 = 0042			CRITIC      = $0042
    29 				; 
    30 				; PAGE 2
    31 				; 
    32 = 022F			SDMCTL      = $022F
    33 = 02E7			MEMLO       = $02E7
    34 				; 
    35 				; PAGE 3
    36 				; 
    37 = 0300			DDEVIC      = $0300
    38 = 0301			DUNIT       = $0301
    39 = 0302			DCOMND      = $0302
    40 = 0303			DSTATS		= $0303
    41 = 0304			DBUFLO      = $0304
    42 = 0305			DBUFHI      = $0305
    43 = 0308			DBYTLO      = $0308
    44 = 0309			DBYTHI      = $0309
    45 = 030A			DAUX1       = $030A
    46 = 030B			DAUX2       = $030B
    47 = 0340			IOCB0       = $0340
    48 				; 
    49 				; PIA
    50 				; 
    51 = D300			PORTA       = $D300
    52 = D301			PORTB       = $D301
    53 = D302			PACTL       = $D302
    54 = D303			PBCTL       = $D303
    55 				; 
    56 				; ANTIC
    57 				;
    58 = D400			DMACTL      = $D400 
    59 = D40A			WSYNC       = $D40A
    60 = D40E			NMIEN       = $D40E
    61 				; 
    62 				; ROM VECTORS
    63 				; 
    64 = E456			CIOV        = $E456
    65 				;
    66 				; SpartaDOS 
    67 				;
    68 = 000A			SD_BUFOFF      = $0A ; offset in line buffer
    69 = 003F			SD_LBUF        = $3F ; offset to line buffer
    70 = 0003			SD_ZCRNAME     = $03 ; offset for jmp to crunch name
    71 = 0021			SD_COMFNAM     = $21 ; offset to result buffer for crunch name 
    72 = 000A			SD_LSIO        = $0A ; negative offset to SIO vector
    73
    74 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    75 				; 
    76 				; The!Cart programming information
    77 				; (c) 2013 Matthias Reichl
    78 				;
    79 				; The!Cart is equipped with 128MB flash (Spansion S29GL01
    80 				; chip), 512k RAM and a 256-byte SPI EEPROM (Microchip
    81 				; 25AA020A). The memory is addressed using 16384 8k banks
    82 				; (64 8k banks when using RAM instead of flash).
    83 				; 
    84 				; The cartridge configuration registers are located at
    85 				; $D5A0-$D5A8. All registers are read/write unless noted
    86 				; otherwise. Unused bits shall be written as '0' and
    87 				; always read back as '0'.
    88 				; 
    89 				; Powerup configuration is 8k mode ($A000-$BFFF) using
    90 				; flash bank 0, writes to flash are disabled.
    91 				; 
    92 				; Depending on the selected cartridge mode additional
    93 				; registers are enabled at $D5xx.
    94 				; 
    95 				; The primary bank register also serves as a base bank
    96 				; register for the various sub-modes.
    97 				; 
    98 				; The secondary bank register is only used in "flexi mode".
    99 				;
   100
   101 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   102 				; 
   103 				; The!Cart Register (from-to,default)
   104 				;
   105
   106 				; Mode Select
   107 = D5A6			TCMOSL = $d5a6    ; mode ($00-$3d,$01)
   108 				; Cartridge mode is selected with bits 0-5 of $D5A6, values
   109 				; other than the ones listed here are reserved (and result
   110 				; in "cartridge off"):
   111 				; $00: off, cartridge disabled
   112 				; $01: 8k banks at $A000
   113 				; $02: AtariMax 1MBit / 128k
   114 				; $03: Atarimax 8MBit / 1MB
   115 				; $04: OSS M091
   116 				; $08: SDX 64k cart, $D5Ex banking
   117 				; $09: Diamond GOS 64k cart, $D5Dx banking
   118 				; $0A: Express 64k cart, $D57x banking
   119 				; $0C: Atrax 128k cart
   120 				; $0D: Williams 64k cart
   121 				; $20: flexi mode (separate 8k banks at $A000 and $8000)
   122 				; $21: standard 16k cart at $8000-$BFFF
   123 				; $22: MegaMax 16k mode (up to 2MB), AtariMax 8Mbit banking
   124 				; $23: Blizzard 16k
   125 				; $24: Sic!Cart 512k
   126 				; $28: 16k Mega cart
   127 				; $29: 32k Mega cart
   128 				; $2A: 64k Mega cart
   129 				; $2B: 128k Mega cart
   130 				; $2C: 256k Mega cart
   131 				; $2D: 512k Mega cart
   132 				; $2E: 1024k Mega cart
   133 				; $2F: 2048k Mega cart
   134 				; $30: 32k XEGS cart
   135 				; $31: 64k XEGS cart
   136 				; $32: 128k XEGS cart
   137 				; $33: 256k XEGS cart
   138 				; $34: 512k XEGS cart
   139 				; $35: 1024k XEGS cart
   140 				; $38: 32k SWXEGS cart
   141 				; $39: 64k SWXEGS cart
   142 				; $3A: 128k SWXEGS cart
   143 				; $3B: 256k SWXEGS cart
   144 				; $3C: 512k SWXEGS cart
   145 				; $3D: 1024k SWXEGS cart
   146 = 0000			TCMOSL.OFF   = $00    ; off, cartridge disabled
   147 = 0001			TCMOSL.8K    = $01    ; 8k banks at $A000
   148 = 0021			TCMOSL.FLEXI = $21    ; flexi mode,
   149 				                         ; separate 8k banks at $A000 and $8000
   150 = 0021			TCMOSL.16K   = $21    ; standard 16k cart at $8000-$BFFF
   151
   152 				; how to figure out that The!Cart is not active?
   153 				; If the address is not used then the XL returns $ff but
   154 				; the XE (and old 800) return $d5 (high byte of address,
   155 				; the value of the last bus cycle)
   156 = 00FF			TCMOSL.XLLOCK  = $ff    ; config lock or not present
   157 = 00D5			TCMOSL.XELOCK  = $d5    ; config lock or not present
   158
   159 				; Mode Flash/RAM Select
   160 = D5A7			TCMOFR = $d5a7    ;flash/RAM mode (0-15,0)
   161 				; bit 0: primary bank write enable (0=readOnly, 1=write)
   162 				; bit 1: primary bank source (0=flash, 1=RAM)
   163 				; bit 2: secondary bank write enable (0=readOnly, 1=write)
   164 				; bit 3: secondary bank source (0=flash, 1=RAM)
   165 = 0000			TCMOFR.FLASH = $00
   166 = 0003			TCMOFR.PBRAM = $03    ; primary bank RAM
   167 = 000C			TCMOFR.SBRAM = $0C    ; secondary bank RAM
   168
   169 				; Primary Bank
   170 = D5A0			TCPBRL = $d5a0    ; register low byte (0-255,0)
   171 = D5A1			TCPBRH = $d5a1    ; register high byte (0-63,0)
   172 = D5A2			TCPBEN = $d5a2    ; enable (0=dis-1=en,1)
   173
   174 				; Secondary Bank 
   175 = D5A3			TCSBRL = $d5a3    ; register low byte (0-255,0)
   176 = D5A4			TCSBRH = $d5a4  ; register high byte (0-63,0)
   177 = D5A5			TCSBEN = $d5a5    ; enable (0=dis-1=en,0)
   178
   179 				; SPI interface to EEPROM
   180 = D5A8			TCINEP = $d5a8
   181 				; bit 0: SPI CLK
   182 				; bit 1: SPI CS
   183 				; bit 7: SPI data in (on reads), SPI data out (on writes)
   184
   185 				; configuration lock
   186 = D5AF			TCCOLO = $d5af
   187 				; Writing to this register disables "The!Cart" registers
   188 				; at $d5aX.
   189
   190
   191 				; macros
   192
   193 				; saves register: pushes bank register on stack
   194 				M_cart_push .macro
   195 				            lda TCMOSL
   196 				            pha
   197 				            lda TCMOFR
   198 				            pha
   199 				            lda TCPBRL
   200 				            pha
   201 				            lda TCPBRH
   202 				            pha
   203 				            lda TCPBEN
   204 				            pha
   205 				            .endm
   206
   207 				; restores register from stack: pops from stack
   208 				M_cart_pop  .macro
   209 				            pla                 
   210 				            sta TCPBEN          
   211 				            pla                 
   212 				            sta TCPBRH          
   213 				            pla                 
   214 				            sta TCPBRL          
   215 				            pla                 
   216 				            sta TCMOFR          
   217 				            pla                 
   218 				            sta TCMOSL          
   219 				            .endm
   220 				 
   221 				; set bank: number of bank in X, uses A
   222 				M_cart_set  .macro
   223 				; set new The!Cart mode
   224 				            lda #TCMOSL.16K         ; set 2x8k mode at $8000-$BFFF
   225 				            sta TCMOSL          
   226 				            lda #TCMOFR.PBRAM       ; set to RAM
   227 				            sta TCMOFR
   228 				            txa
   229 				            asl   
   230 				            sta TCPBRL              ; get bank number from X
   231 				            lda #$00                     
   232 				            sta TCPBRH              ; set high to $00
   233 				            lda #$01
   234 				            sta TCPBEN              ; enable        
   235 				            .endm
   236 				;
   237 				; Start of code
   238 				;
   239 				            org $3000
   240 				            
   241 				; info message
   242 FFFF> 3000-3681> 20 82 +             jsr PRINT
   243 3003 54 68 65 21 52 61 +             .byte 'The!Ramdisk for The!Cart ver64 by hjx',$9B,$FF
   244
   245 				; check for The!Cart
   246 302A AD A6 D5		             lda TCMOSL
   247 302D C9 FF		             cmp #TCMOSL.XLLOCK
   248 302F F0 04		             beq NORAMDISK
   249 3031 C9 D5		             cmp #TCMOSL.XELOCK
   250 3033 D0 23		             bne RAMDISKINI
   251 3035			NORAMDISK
   252 				; no banks            
   253 3035 20 82 34		            jsr PRINT
   254 3038 20 20 45 72 72 6F +             .byte '  Error: The!Cart not found',$9B,$FF
   255 3055 4C 25 31		            jmp PRNHLP
   256 				                        
   257 3058			RAMDISKINI
   258 				; check for parameter
   259 3058 20 8E 33					jsr PARAMCHECK
   260 305B B0 23		            bcs PRSPARM
   261 				; no parameter -> error
   262 305D 20 82 34		            jsr PRINT
   263 3060 20 20 45 72 72 6F +             .byte '  Error: No parameter',$9B,$FF
   264 3077 4C 25 31		            jmp PRNHLP
   265
   266 				; jump for jsr to crunch name
   267 307A 4C FF FF		CRNAME      jmp $FFFF
   268
   269 307D 00			CHKFRMT     .byte $00
   270 307E 00			CHKDRVR     .byte $00
   271 307F 00			CHKOPTN     .byte $00
   272
   273 				; set crunch name address
   274 3080 A5 0A		PRSPARM     lda DOSVEC
   275 3082 18			            clc
   276 3083 69 03		            adc #SD_ZCRNAME
   277 3085 8D 7B 30		            sta CRNAME+1
   278 3088 A5 0B		            lda DOSVEC+1
   279 308A 69 00		            adc #$00
   280 308C 8D 7C 30		            sta CRNAME+2
   281 				            
   282 				; parameter parsing            
   283 				; get drive number SD_COMFNAM starts alway with Dx:
   284 308F 20 7A 30		            jsr CRNAME
   285 3092 D0 74		            bne PARAMERR
   286 3094 A0 22		            ldy #SD_COMFNAM+1
   287 3096 B1 0A		            lda (DOSVEC),Y
   288 3098 29 0F		            and #$0F
   289 309A 8D 80 36		            sta DRVNUM
   290
   291 309D 20 8E 33					jsr PARAMCHECK
   292 30A0 90 40		            bcc PRSPAREND
   293
   294 30A2 20 7A 30		            jsr CRNAME
   295 30A5 D0 0E		            bne PARAMOPT
   296 30A7 A0 22		            ldy #SD_COMFNAM+1
   297 30A9 B1 0A		            lda (DOSVEC),Y
   298 30AB 29 0F		            and #$0F
   299 30AD 8D 81 36		            sta FDRVNUM
   300 				            
   301 				; check options /xxx
   302 30B0 20 7A 30		            jsr CRNAME
   303 30B3 F0 2D		            beq PRSPAREND
   304
   305 30B5 A0 24		PARAMOPT	ldy #SD_COMFNAM+3
   306 30B7 B1 0A		            lda (DOSVEC),Y
   307 30B9 C9 2F		            cmp #'/'
   308 30BB D0 4B		            bne PARAMERR
   309 30BD C8			PRSPARLOOP  iny
   310 30BE B1 0A		            lda (DOSVEC),Y
   311
   312 30C0 C9 9B		            cmp #$9B         ; end of parameter
   313 30C2 F0 1E		            beq PRSPAREND
   314 				            
   315 30C4 C9 46		PRSPARNXT1  cmp #'F'         ; format only ?
   316 30C6 D0 0B		            bne PRSPARNXT2
   317 30C8 A9 FF		            lda #$FF
   318 30CA 8D 7F 30		            sta CHKOPTN
   319 30CD 8D 7D 30		            sta CHKFRMT
   320 30D0 4C BD 30		            jmp PRSPARLOOP
   321
   322 30D3 C9 44		PRSPARNXT2  cmp #'D'         ; driver only ?
   323 30D5 D0 31		            bne PARAMERR
   324 30D7 A9 FF		            lda #$FF
   325 30D9 8D 7F 30		            sta CHKOPTN
   326 30DC 8D 7E 30		            sta CHKDRVR
   327 30DF 4C BD 30		            jmp PRSPARLOOP
   328
   329 30E2			PRSPAREND
   330 				; set format and ini by options
   331 30E2 2C 7F 30		            bit CHKOPTN
   332 30E5 30 08		            bmi STRTINIFMT ; no options set default /DF
   333 30E7 A9 FF		            lda #$FF
   334 30E9 8D 7E 30		            sta CHKDRVR
   335 30EC 8D 7D 30		            sta CHKFRMT
   336 30EF			STRTINIFMT
   337 				; install driver requested
   338 30EF 2C 7E 30		            bit CHKDRVR
   339 30F2 10 03		            bpl NOINIDRV
   340 30F4 20 11 32		            jsr STARTINST
   341 30F7			NOINIDRV
   342 				; format if requested
   343 30F7 2C 7F 30		            bit CHKOPTN
   344 30FA 30 03		            bmi NOPREFRMT
   345 30FC 20 E2 33		            jsr CHECKFRMT
   346 30FF			NOPREFRMT
   347 30FF 2C 7D 30		            bit CHKFRMT
   348 3102 10 03		            bpl NOFRMTRD
   349 3104 20 AC 32		            jsr FRMTRD
   350 3107			NOFRMTRD
   351 3107 60			            rts
   352
   353 3108 20 82 34		PARAMERR    jsr PRINT
   354 310B 20 20 45 72 72 6F +             .byte '  Error: Wrong parameter',$9B,$FF
   355 3125			PRNHLP
   356 3125 20 82 34		            jsr PRINT
   357 3128 20 20 55 73 65 20 +             .byte '  Use RAMCART Dx: [Dy:] [/DF]',$9B
   358 3146 20 20 20 20 78 20 +             .byte '    x - drive number for ramdisk',$9B
   359 3167 20 20 20 20 79 20 +             .byte '    y - drive number for flashdisk',$9B
   360 318A 20 20 20 20 44 20 +             .byte '    D - install driver only',$9B
   361 31A6 20 20 20 20 46 20 +             .byte '    F - format ramdisk only',$9B
   362 31C2 20 20 55 73 65 20 +             .byte '  Use shift+return/esc in start menu.',$9B
   363 31E8 20 20 49 66 20 44 +             .byte '  If Dx: equals Dy: then Dy: precedes.',$9B,$FF
   364 3210 60			            rts
   365
   366 3211			STARTINST   
   367 3211 20 82 34		            jsr PRINT
   368 3214 44 72 69 76 65 72 +             .byte 'Driver installed ',$ff
   369
   370 3226 AD 80 36		            lda DRVNUM
   371 3229 30 17		            bmi PRTFLASHDRV
   372 322B CD 81 36					cmp FDRVNUM
   373 322E F0 12					beq PRTFLASHDRV
   374 3230 18			            clc
   375 3231 69 30		            adc #'0'
   376 3233 8D 3E 32		            sta ramDx
   377 3236 20 82 34					jsr PRINT
   378 3239 52 41 4D 3D 44	            .byte 'RAM=D'
   379 323E 78 3A 20 FF		ramDx       .byte 'x: ',$ff
   380
   381 3242			PRTFLASHDRV
   382 3242 AD 81 36		            lda FDRVNUM
   383 3245 30 13		            bmi PRTDRVEND
   384 3247 18			            clc
   385 3248 69 30		            adc #'0'
   386 324A 8D 57 32		            sta flashDy
   387 324D 20 82 34					jsr PRINT
   388 3250 46 6C 61 73 68 3D + 			.byte 'Flash=D'
   389 3257 79 3A FF		flashDy     .byte 'y:',$ff
   390
   391 325A			PRTDRVEND
   392 325A 20 82 34					jsr PRINT
   393 325D 9B FF					.byte $9B,$FF
   394
   395 				; set jsr to original DOSINI
   396 325F A5 0C		            lda DOSINI
   397 3261 8D B9 34		            sta JSRDOSINI+1
   398 3264 A5 0D		            lda DOSINI+1
   399 3266 8D BA 34		            sta JSRDOSINI+2
   400
   401 				; set MEMLO oldaddress, realloc
   402 3269 AD E7 02		            lda MEMLO
   403 326C 8D 2D 38		            sta READSTADR
   404 326F 8D 33 38		            sta CPYTOADR
   405 3272 AD E8 02		            lda MEMLO+1
   406 3275 8D 2E 38		            sta READSTADR+1
   407 3278 8D 34 38		            sta CPYTOADR+1
   408 				;
   409 				; start realloc
   410 				;
   411 327B 20 65 37		            jsr REASTART
   412
   413 				; set new DOSINI            
   414 327E A9 B8		REAL001     lda #<JSRDOSINI
   415 3280 85 0C		            sta DOSINI
   416 3282 A9 34		REAH001     lda #>JSRDOSINI
   417 3284 85 0D		            sta DOSINI+1
   418 				; get SIO and patch for RAMDISK
   419 3286 38			            sec
   420 3287 A5 0A		            lda DOSVEC
   421 3289 E9 0A		            sbc #SD_LSIO
   422 328B 85 32		            sta BUFRLO
   423 328D A5 0B		            lda DOSVEC+1
   424 328F E9 00		            sbc #$00
   425 3291 85 33		            sta BUFRHI
   426 3293 A0 00		            ldy #$00
   427 3295 B1 32		            lda (BUFRLO),Y
   428 3297 8D DE 34		REAA001     sta JMPSIO+1      ;realloc $33CA
   429 329A A9 C6		REAL002     lda #<RAMDSIO
   430 329C 91 32		            sta (BUFRLO),Y
   431 329E C8			            iny
   432 329F B1 32		            lda (BUFRLO),Y
   433 32A1 8D DF 34		REAA002     sta JMPSIO+2      ;realloc $33D4
   434 32A4 A9 34		REAH002     lda #>RAMDSIO
   435 32A6 91 32		            sta (BUFRLO),Y
   436 				; set MEMLO            
   437 32A8 20 BB 34		REAA003     jsr SETMEMLO      ;realloc $33DB
   438 32AB 60			            rts
   439
   440 				; format ramdisk
   441 32AC 20 82 34		FRMTRD      jsr PRINT
   442 32AF 52 61 6D 64 69 73 +             .byte 'Ramdisk formatted',$9B,$FF
   443
   444 32C2 20 12 34		            jsr cart_save
   445
   446 				; clear sector 1-4
   447 32C5 A2 00		_loop03     ldx #$00
   448 32C7 20 58 34		            jsr cart_set
   449 32CA A9 00		            lda #$00
   450 32CC A0 7F		            ldy #$7f
   451 32CE 99 00 80		FRMTCLP03   sta $8000,Y
   452 32D1 88			            dey
   453 32D2 10 FA		            bpl FRMTCLP03
   454 32D4 20 31 34		            jsr cart_restore
   455 32D7 AD CF 32		            lda FRMTCLP03+1
   456 32DA 18			            clc
   457 32DB 69 80		            adc #$80
   458 32DD 8D CF 32		            sta FRMTCLP03+1
   459 32E0 AD D0 32		            lda FRMTCLP03+2
   460 32E3 69 00		            adc #$00
   461 32E5 8D D0 32		            sta FRMTCLP03+2
   462 32E8 A9 04		_loopcnt03  lda #$04
   463 32EA CE E9 32		            dec _loopcnt03+1
   464 32ED D0 D6		            bne _loop03
   465
   466 				; header loop            
   467 32EF A2 00		            ldx #$00
   468 32F1 20 58 34		            jsr cart_set
   469 32F4 A0 2B		            ldy #$2b
   470 32F6 B9 9F 33		_loopheader lda RDHEAD,Y
   471 32F9 99 00 80		            sta $8000,Y		; sector 1
   472 32FC 88			            dey
   473 32FD 10 F7		            bpl _loopheader
   474 32FF A9 60		            lda #$60    ; write RTS to second boot sector
   475 3301 8D 80 80		            sta $8080   ; see header jmp $3080, sector 2
   476 3304 20 31 34		            jsr cart_restore
   477
   478
   479 				; set sector 4-7 to $ff VTOV 512k = 4096 sectors
   480 				; = 4 VTOC sectors
   481 3307 A2 00		_loop47     ldx #$00
   482 3309 20 58 34		            jsr cart_set
   483 330C A9 FF		            lda #$ff
   484 330E A0 7F		            ldy #$7f
   485 3310 99 80 81		FRMTCLP47   sta $8180,Y
   486 3313 88			            dey
   487 3314 10 FA		            bpl FRMTCLP47
   488 3316 20 31 34		            jsr cart_restore
   489 3319 AD 11 33		            lda FRMTCLP47+1
   490 331C 18			            clc
   491 331D 69 80		            adc #$80
   492 331F 8D 11 33		            sta FRMTCLP47+1
   493 3322 AD 12 33		            lda FRMTCLP47+2
   494 3325 69 00		            adc #$00
   495 3327 8D 12 33		            sta FRMTCLP47+2
   496 332A A9 04		_loopcnt47  lda #$04
   497 332C CE 2B 33		            dec _loopcnt47+1
   498 332F D0 D6		            bne _loop47
   499
   500 				; clear sector 8-9 
   501 3331 A2 00		_loop89     ldx #$00
   502 3333 20 58 34		            jsr cart_set
   503 3336 A9 00		            lda #$00
   504 3338 A0 7F		            ldy #$7f
   505 333A 99 80 83		FRMTCLP89   sta $8380,Y
   506 333D 88			            dey
   507 333E 10 FA		            bpl FRMTCLP89
   508 3340 20 31 34		            jsr cart_restore
   509 3343 AD 3B 33		            lda FRMTCLP89+1
   510 3346 18			            clc
   511 3347 69 80		            adc #$80
   512 3349 8D 3B 33		            sta FRMTCLP89+1
   513 334C AD 3C 33		            lda FRMTCLP89+2
   514 334F 69 00		            adc #$00
   515 3351 8D 3C 33		            sta FRMTCLP89+2
   516 3354 A9 02		_loopcnt89  lda #$02
   517 3356 CE 55 33		            dec _loopcnt89+1
   518 3359 D0 D6		            bne _loop89
   519
   520 335B A2 00		            ldx #$00
   521 335D 20 58 34		            jsr cart_set
   522 				; mark used sectors
   523 3360 A9 00		            lda #$00
   524 3362 8D 80 81		            sta $8180   ; sector 1-8
   525 3365 A9 3F		            lda #$3f
   526 3367 8D 81 81		            sta $8181   ; sector 9
   527 				;            lda #$fe
   528 				;            sta $83ff   ; sector 4096 does not exit
   529 				; set sector map for MAIN
   530 336A A9 00		            lda #$00    ; two words $0000 (first and last)
   531 336C 8D 80 83		            sta $8380
   532 336F 8D 81 83		            sta $8381
   533 3372 8D 82 83		            sta $8382
   534 3375 8D 83 83		            sta $8383
   535 3378 A9 09		            lda #$09    ;  and third $0009 start of main
   536 337A 8D 84 83		            sta $8384
   537 				; set MAIN directory            
   538 337D A2 00		            ldx #$00
   539 337F BD CB 33		_loopmain   lda RDMAIN,x
   540 3382 9D 00 84		            sta $8400,x
   541 3385 E8			            inx
   542 3386 E0 17		            cpx #$17
   543 3388 D0 F5		            bne _loopmain
   544 338A 20 31 34		            jsr cart_restore
   545 				; finished
   546 338D 60			            rts
   547 				            
   548 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   549 				;
   550 				; parameter subroutines            
   551 				;
   552
   553 				;
   554 				; check for next parameter
   555 				;   sets carry if next parameter is available
   556 				;
   557 338E A0 0A		PARAMCHECK	ldy #SD_BUFOFF
   558 3390 B1 0A		            lda (DOSVEC),Y
   559 3392 18			            clc
   560 3393 69 3F		            adc #SD_LBUF
   561 3395 A8			            tay
   562 3396 B1 0A		            lda (DOSVEC),Y
   563 3398 C9 9B		            cmp #$9b
   564 339A 18			            clc
   565 339B F0 01		            beq PARAMCHECKE
   566 339D 38						sec
   567 339E 60			PARAMCHECKE	rts
   568 				            
   569 				; load boot sector to $3000 start $3080 and RTS ($60)
   570 339F 00			RDHEAD      .byte $00 ; Usually 0. Some formatting tools put a $53 (='S) for SD here.
   571 33A0 03			            .byte $03 ; Number of sectors to boot.
   572 33A1 00 30		            .byte $00,$30 ; Address where the boot sectors are loaded to
   573 33A3 E0 07		            .byte $E0,$07 ; This address is copied to DOSINI
   574 33A5 4C 80 30		            .byte $4c,$80,$30 ; After boot jump here: jmp $3080 (just RTS)
   575 33A8 08 00		            .byte $08,$00 ; Sector number of the first sector map of the MAIN directory
   576 33AA 00 10		            .word $1000 ; total sector count
   577 33AC F6 0F		            .word $0ff6 ; free sector count
   578 33AE 04			            .byte $04 ; Number of bit map sectors on the disk
   579 33AF 04 00		            .byte $04,$00 ; Sector number of the first bit map sector
   580 33B1 28 00		            .byte $28,$00 ; Sector number to begin the file data sector allocation search
   581 33B3 0A 00		            .byte $0A,$00 ; Sector number to begin the directory data sector allocation search
   582 33B5 43 41 52 54 35 31 +             .byte 'CART512K' ; Volume name, 8 chars
   583 33BD 01			            .byte $01 ; Tracks on disk (1 for ramdisks and HDs)
   584 33BE 80			            .byte $80 ; Sector size ($80=128,$00=256,$01=512)
   585 33BF 20			            .byte $20 ; File system version ($20=SD1.1-4.2 version 2.0, $21=Sd4.4> version 2.1) 
   586 33C0 00 00 00 00 00	            .byte $00,$00,$00,$00,$00 ; reserved - no known use
   587 33C5 00			            .byte $00 ; Volume sequence number
   588 33C6 00			            .byte $00 ; Volume random number
   589 33C7 00 00		            .byte $00,$00 ; Sector number of the first sector map of the file to be loaded when the disk is booted
   590 33C9 00			            .byte $00 ; Lock flag ($ff=locked, $00=unlocked)
   591 33CA 00			            .byte $00
   592
   593 33CB 28			RDMAIN      .byte $28 ; Bits 7-0: OpenWrite,-,SubDir,Del,Used,Arc,Hid,Prot
   594 33CC 00 00		            .word $0000 ; First sector map of parent directory (MAIN=0)
   595 33CE 17 00 00		            .byte $17,$00,$00 ; length of directory in bytes (always times 23 bytes)
   596 33D1 4D 41 49 4E 20 20 + RDMAINNAME  .byte 'MAIN       ' ; Name 11 chars
   597 33DC 0B 07 47		            .byte $0b,$07,$47 ; Date DD/MM/YY
   598 33DF 0B 0B 0B		            .byte $0b,$0b,$0b ; Time HH:MM:SS
   599
   600 				; check preformat
   601 33E2			checkfrmt
   602 33E2 20 12 34		            jsr cart_save
   603 33E5 A2 00		            ldx #$00
   604 33E7 20 58 34		            jsr cart_set
   605
   606 33EA BD D1 33		_nxtcharv   lda RDMAINNAME,x    ; check volume name
   607 33ED DD 06 84		            cmp $8406,x			; sector $09
   608 33F0 D0 0F		            bne _nofrmt
   609 33F2 E8			            inx
   610 33F3 E0 0B		            cpx #$0b
   611 33F5 D0 F3		            bne _nxtcharv
   612 				            
   613 33F7 20 31 34		            jsr cart_restore
   614 33FA A9 00		            lda #$00
   615 33FC 8D 7D 30		            sta CHKFRMT
   616 33FF 38			            sec
   617 3400 60			            rts
   618 				            
   619 3401 20 31 34		_nofrmt     jsr cart_restore
   620 3404 A9 FF		            lda #$FF
   621 3406 8D 7D 30		            sta CHKFRMT
   622 3409 18			            clc
   623 340A 60			            rts
   624
   625 				; wait for sync            
   626 340B A5 14		WAITSYNC    lda RTCLOK+2
   627 340D C5 14		WAITLOOP    cmp RTCLOK+2
   628 340F F0 FC		            beq WAITLOOP
   629 3411 60			            rts
   630
   631 3412			cart_save
   632 3412 AD A6 D5		            lda TCMOSL
   633 3415 8D 7D 34		            sta _tcmosl
   634 3418 AD A7 D5		            lda TCMOFR
   635 341B 8D 7E 34		            sta _tcmofr
   636 341E AD A0 D5		            lda TCPBRL
   637 3421 8D 7F 34		            sta _tcpbrl
   638 3424 AD A1 D5		            lda TCPBRH
   639 3427 8D 80 34		            sta _tcpbrh
   640 342A AD A2 D5		            lda TCPBEN
   641 342D 8D 81 34		            sta _tcpben
   642
   643 3430 60			            rts
   644
   645 3431			cart_restore
   646 3431 AD 7D 34		            lda _tcmosl
   647 3434 8D A6 D5		            sta TCMOSL
   648 3437 AD 7E 34		            lda _tcmofr
   649 343A 8D A7 D5		            sta TCMOFR
   650 343D AD 7F 34		            lda _tcpbrl
   651 3440 8D A0 D5		            sta TCPBRL
   652 3443 AD 80 34		            lda _tcpbrh
   653 3446 8D A1 D5		            sta TCPBRH
   654 3449 AD 81 34		            lda _tcpben
   655 344C 8D A2 D5		            sta TCPBEN
   656
   657 344F A9 E0		            lda #$e0          ; enable interrupts
   658 3451 8D 0E D4		            sta NMIEN
   659 3454 58			            cli
   660 3455 C6 42		            dec CRITIC 
   661
   662 3457 60			            rts
   663
   664 3458			cart_set
   665 3458 E6 42		            inc CRITIC 
   666 345A 20 0B 34		            jsr WAITSYNC        ; wait for vblank
   667 345D 78			            sei                 ; disable interrupt
   668 345E A9 00		            lda #$00
   669 3460 8D 0E D4		            sta NMIEN
   670
   671 3463 A9 21		            lda #TCMOSL.16K         ; set 2x8k mode at $8000-$BFFF
   672 3465 8D A6 D5		            sta TCMOSL          
   673 3468 A9 03		            lda #TCMOFR.PBRAM       ; set to RAM
   674 346A 8D A7 D5		            sta TCMOFR
   675 346D 8A			            txa
   676 346E 0A			            asl   
   677 346F 8D A0 D5		            sta TCPBRL              ; get bank number from X
   678 3472 A9 00		            lda #$00                     
   679 3474 8D A1 D5		            sta TCPBRH              ; set high to $00
   680 3477 A9 01		            lda #$01
   681 3479 8D A2 D5		            sta TCPBEN              ; enable        
   682
   683 347C 60			            rts            
   684
   685 347D 00			_tcmosl     .byte $00
   686 347E 00			_tcmofr     .byte $00
   687 347F 00			_tcpbrl     .byte $00
   688 3480 00			_tcpbrh     .byte $00
   689 3481 00			_tcpben     .byte $00
   690
   691 				; print subroutine            
   692 3482 68			PRINT       pla
   693 3483 8D 93 34		            sta PRINTITER+1
   694 3486 68			            pla
   695 3487 8D 94 34		            sta PRINTITER+2
   696 348A EE 93 34		PRINTLOOP   inc PRINTITER+1
   697 348D D0 03		            bne PRINTITER
   698 348F EE 94 34		            inc PRINTITER+2
   699 3492 AD FF FF		PRINTITER   lda $FFFF
   700 3495 C9 FF		            cmp #$FF
   701 3497 F0 06		            beq PRINTEND
   702 3499 20 A8 34		            jsr CIOPUTCHR
   703 349C 4C 8A 34		            jmp PRINTLOOP
   704 349F AD 94 34		PRINTEND    lda PRINTITER+2
   705 34A2 48			            pha
   706 34A3 AD 93 34		            lda PRINTITER+1
   707 34A6 48			            pha
   708 34A7 60			            rts
   709 				; call cio put char subroutine
   710 34A8 A2 00		CIOPUTCHR   ldx #$00
   711 34AA 8E 48 03		            stx IOCB0+ICBLL
   712 34AD 8E 49 03		            stx IOCB0+ICBLH
   713 34B0 A0 0B		            ldy #$0B
   714 34B2 8C 42 03		            sty IOCB0+ICCOM
   715 34B5 4C 56 E4		            jmp CIOV
   716
   717
   718
   719 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   720 				;;; BEGIN OF REALLOC BLOCK
   721 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   722
   723 				; to realloc routines
   724 				; DOSINI set MEMLO at reset
   725 34B8			REABEGIN
   726
   727 34B8 20 00 00		JSRDOSINI   jsr $0000
   728 34BB			SETMEMLO    
   729 34BB A9 02		REAL003     lda #<REAEND
   730 34BD 8D E7 02		            sta MEMLO
   731 34C0 A9 37		REAH003     lda #>REAEND
   732 34C2 8D E8 02		            sta MEMLO+1
   733 34C5 60			            rts
   734
   735 				; new DOSVEC for RAMDISK device
   736 34C6 AD 00 03		RAMDSIO     lda DDEVIC
   737 34C9 C9 31		            cmp #$31
   738 34CB D0 10		            bne JMPSIO
   739 34CD AD 80 36		REAA004     lda DRVNUM  ; check drive number for RAM
   740 34D0 CD 01 03		            cmp DUNIT
   741 34D3 F0 0B		            beq NEWSIOGO
   742 34D5 AD 81 36		REAA026		lda FDRVNUM  ; check drive number for Flash
   743 34D8 CD 01 03		            cmp DUNIT
   744 34DB F0 03		            beq NEWSIOGO
   745 34DD 4C 00 00		JMPSIO      jmp $0000
   746
   747 				; set buffer address
   748 34E0 AD 04 03		NEWSIOGO    lda DBUFLO
   749 34E3 85 34		            sta BFENLO
   750 34E5 AD 05 03		            lda DBUFHI
   751 34E8 85 35		            sta BFENHI
   752 				; load commad byte            
   753 34EA AD 02 03		            lda DCOMND
   754 				; command STATUS REQUEST
   755 34ED C9 53		            cmp #$53 
   756 34EF D0 1B		            bne NEXT1
   757 34F1 AD 7B 36		REAA009     lda CONFSECSIZ
   758 34F4 4A			            lsr
   759 34F5 4A			            lsr
   760 34F6 49 30		            eor #$30
   761 34F8 AC 77 36		REAA010     ldy L36BB
   762 34FB C0 1A		            cpy #$1A
   763 34FD D0 02		            bne L35B4
   764 34FF 09 80		            ora #$80
   765 3501 A0 00		L35B4       ldy #$00
   766 3503 91 34		            sta (BFENLO),Y
   767 3505 C8			            iny
   768 3506 A9 FF		            lda #$FF
   769 3508 91 34		            sta (BFENLO),Y
   770 350A 30 24		            bmi JMPSIOEND
   771 				            
   772 				; command RETURN CONFIGURATION            
   773 350C C9 4E		NEXT1       cmp #$4E
   774 350E D0 0C		            bne NEXT2
   775 3510 A0 0B		            ldy #$0B            ; 12 bytes
   776 3512			RETCNFLOOP
   777 3512 B9 74 36		REAA011     lda CONFBUF,Y
   778 3515 91 34		            sta (BFENLO),Y
   779 3517 88			            dey
   780 3518 10 F8		            bpl RETCNFLOOP
   781 351A 30 14		            bmi JMPSIOEND
   782
   783 				; command SET CONFIGURATION
   784 351C C9 4F		NEXT2       cmp #$4F
   785 351E D0 13		            bne NEXT3
   786 3520 A0 07		            ldy #$07
   787 3522 B1 34		            lda (BFENLO),Y
   788 3524 F0 38		            beq REAA020         ; error if sec size <> $80 ( $00 -> $100)            
   789 3526 8D 7B 36		REAA012     sta CONFSECSIZ
   790 3529 A0 03		            ldy #$03
   791 352B B1 34		            lda (BFENLO),Y
   792 352D 8D 77 36		REAA013     sta L36BB
   793
   794 3530			JMPSIOEND
   795 3530 4C 6A 36		REAA014     jmp RDSIOEND
   796
   797 				; command FORMAT DISK
   798 3533 C9 21		NEXT3       cmp #$21
   799 3535 D0 0B		            bne NEXT4
   800 3537 A0 00		SIOFRMT     ldy #$00
   801 3539 A9 FF		            lda #$FF
   802 353B 91 34		            sta (BFENLO),Y
   803 353D C8			            iny
   804 353E 91 34		            sta (BFENLO),Y
   805 3540 D0 EE		            bne JMPSIOEND
   806
   807 				; command FORMAT DISK ENHANCED
   808 3542 C9 22		NEXT4       cmp #$22
   809 3544 D0 0C		            bne NEXT5
   810 3546 A9 1A		            lda #$1A
   811 3548 8D 77 36		REAA015     sta L36BB
   812 354B A9 80		            lda #$80
   813 354D 8D 7B 36		REAA016     sta CONFSECSIZ
   814 3550 D0 E5		            bne SIOFRMT
   815 				            
   816 				; command PUT/GET SECTOR 
   817 3552 C9 52		NEXT5       cmp #$52            ; command GET SECTOR
   818 3554 F0 0B		            beq PUTGETSEC
   819 3556 C9 57		            cmp #$57            ; command PUT SECTOR WITH VERIFY
   820 3558 F0 07		            beq PUTGETSEC
   821 355A C9 50		            cmp #$50            ; command PUT SECTOR
   822 355C F0 03		            beq PUTGETSEC
   823 355E 4C 6D 36		REAA020     jmp RDSIOEND+3      ; error NAK, command not supported
   824 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   825 				; buffer address and calc byte count
   826 3561 A9 00		PUTGETSEC   lda #$00
   827 3563 85 32		            sta BUFRLO
   828 3565 AD 0A 03		            lda DAUX1
   829 3568 38			            sec
   830 3569 E9 01		            sbc #$01
   831 356B 85 33		            sta BUFRHI
   832 356D AD 0B 03		            lda DAUX2
   833 3570 E9 00		            sbc #$00
   834 3572 06 33		            asl BUFRHI
   835 3574 2A			            rol
   836 3575 AA			            tax                 ; set X with memory bank number
   837 3576 A5 33		            lda BUFRHI
   838 3578 4A			            lsr
   839 3579 4A			            lsr
   840 357A 66 32		            ror BUFRLO
   841 357C 09 80		            ora #$80
   842 357E 85 33		            sta BUFRHI
   843 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   844 				; set buffer address in copy loops
   845 3580 A5 32		            lda BUFRLO
   846 3582 8D 15 36		REAA021     sta GETADRLP+1
   847 3585 8D 49 36		REAA022     sta PUTADRLP+1
   848 3588 A5 33		            lda BUFRHI
   849 358A 8D 16 36		REAA023     sta GETADRLP+2
   850 358D 8D 4A 36		REAA024     sta PUTADRLP+2            
   851 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   852 				; check for GET
   853 3590 AD 02 03		            lda DCOMND
   854 3593 C9 52		            cmp #$52
   855 3595 F0 0A		            beq L3656           ; is GET
   856 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   857 				; PUT: put user data to buffer            
   858 3597 A0 7F		            ldy #$7F
   859 3599 B1 34		L364B       lda (BFENLO),Y
   860 359B 99 82 36		REAA005     sta BUFFERXX1,Y
   861 359E 88			            dey
   862 359F 10 F8		            bpl L364B
   863 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   864 				; check if bank number is in range            
   865 35A1 E0 20		L3656       cpx #$20            ; check bank number
   866 35A3 B0 B9		            bcs REAA020         ; intermediate jmp to NAK
   867 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   868 35A5			            M_cart_push         ; save register
Macro: M_CART_PUSH [Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/RAMCART/FTe SpartaDOS 3/RAMCART.ASM]
     1 35A5 AD A6 D5		            lda TCMOSL
     2 35A8 48			            pha
     3 35A9 AD A7 D5		            lda TCMOFR
     4 35AC 48			            pha
     5 35AD AD A0 D5		            lda TCPBRL
     6 35B0 48			            pha
     7 35B1 AD A1 D5		            lda TCPBRH
     8 35B4 48			            pha
     9 35B5 AD A2 D5		            lda TCPBEN
    10 35B8 48			            pha
Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/RAMCART/FTe SpartaDOS 3/RAMCART.ASM
   869 35B9 E6 42		            inc CRITIC
   870 35BB A5 14		            lda RTCLOK+2
   871 35BD C5 14		WAITLOOP2   cmp RTCLOK+2
   872 35BF F0 FC		            beq WAITLOOP2
   873 35C1 78			            sei                 ; disable interrupts
   874 35C2 A9 00		            lda #$00
   875 35C4 8D 0E D4		            sta NMIEN           ; 40 cycles
   876 				; set bank, number in X
   877 35C7 A9 21		            lda #TCMOSL.16K     ; set 2x8k mode at $8000-$BFFF
   878 35C9 8D A6 D5		            sta TCMOSL          
   879
   880 35CC AD 81 36		REAA025     lda FDRVNUM  ; check drive number for flash
   881 35CF CD 01 03		            cmp DUNIT
   882 35D2 D0 23		            bne setTCram
   883
   884 				; 512k user space start bank $3fc0
   885 				; 640k user space start bank $3fb0
   886 35D4 A9 00		setTCflash  lda #TCMOFR.FLASH       ; set to FLASH
   887 35D6 8D A7 D5		            sta TCMOFR
   888 35D9 A9 B0		            lda #$b0
   889 35DB 8D A0 D5		            sta TCPBRL
   890 35DE A9 3F		            lda #$3f
   891 35E0 8D A1 D5		            sta TCPBRH
   892 35E3 8A			            txa
   893 35E4 0A			            asl
   894 35E5 18			            clc   
   895 35E6 6D A0 D5		            adc TCPBRL              ; get bank number from X
   896 35E9 8D A0 D5		            sta TCPBRL
   897 35EC AD A1 D5		            lda TCPBRH
   898 35EF 69 00		            adc #$00                     
   899 35F1 8D A1 D5		            sta TCPBRH              ; set high to $00
   900 35F4 18			            clc
   901 35F5 90 0F		            bcc setTcend
   902
   903 35F7 A9 03		setTCram    lda #TCMOFR.PBRAM       ; set to RAM
   904 35F9 8D A7 D5		            sta TCMOFR
   905 35FC 8A			            txa
   906 35FD 0A			            asl   
   907 35FE 8D A0 D5		            sta TCPBRL              ; get bank number from X
   908 3601 A9 00		            lda #$00                     
   909 3603 8D A1 D5		            sta TCPBRH              ; set high to $00
   910
   911 3606 A9 01		setTCend    lda #$01
   912 3608 8D A2 D5		            sta TCPBEN              ; enable        
   913 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   914 				; check for PUT
   915 360B A0 7F		            ldy #$7F            ; 9 cycles
   916 360D AD 02 03		            lda DCOMND
   917 3610 C9 52		            cmp #$52
   918 3612 D0 31		            bne L369B           ; is PUT
   919 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   920 				; GET: read data to buffer
   921 3614			L367B
   922 3614 B9 FF FF		GETADRLP    lda $FFFF,Y         ; 5 cycles +
   923 3617 99 82 36		REAA006     sta BUFFERXX1,Y     ; 5 cycles +
   924 361A 88			            dey                 ; 2 cycles +
   925 361B 10 F7		            bpl L367B           ; 4 cycles + * 128 = 2048
   926 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   927 				; restore bank for write to user buffer
   928 361D			            M_cart_pop          ; restore register            
Macro: M_CART_POP [Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/RAMCART/FTe SpartaDOS 3/RAMCART.ASM]
     1 361D 68			            pla                 
     2 361E 8D A2 D5		            sta TCPBEN          
     3 3621 68			            pla                 
     4 3622 8D A1 D5		            sta TCPBRH          
     5 3625 68			            pla                 
     6 3626 8D A0 D5		            sta TCPBRL          
     7 3629 68			            pla                 
     8 362A 8D A7 D5		            sta TCMOFR          
     9 362D 68			            pla                 
    10 362E 8D A6 D5		            sta TCMOSL          
Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/RAMCART/FTe SpartaDOS 3/RAMCART.ASM
   929 3631 A9 E0		            lda #$e0            ; enable interrupts
   930 3633 8D 0E D4		            sta NMIEN
   931 3636 58			            cli
   932 3637 C6 42		            dec CRITIC          ; 54 cycles
   933 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;            
   934 				; GET: write buffer to user data            
   935 3639 A0 7F		            ldy #$7F
   936 363B			L368E
   937 363B B9 82 36		REAA008     lda BUFFERXX1,Y
   938 363E 91 34		            sta (BFENLO),Y
   939 3640 88			            dey
   940 3641 10 F8		            bpl L368E
   941 3643 30 25		            bmi RDSIOEND
   942 				            
   943 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   944 				; PUT: buffer data to sector
   945 3645			L369B
   946 3645 B9 82 36		REAA007     lda BUFFERXX1,Y   ; 5 cycles                
   947 3648 99 FF FF		PUTADRLP    sta $FFFF,Y       ; 5 cycles
   948 364B 88			            dey               ; 2 cycles +              
   949 364C 10 F7		            bpl L369B         ; 4 cycles + * 128 = 2048 
   950 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   951 				; restore register
   952 364E			            M_cart_pop          ; restore register
Macro: M_CART_POP [Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/RAMCART/FTe SpartaDOS 3/RAMCART.ASM]
     1 364E 68			            pla                 
     2 364F 8D A2 D5		            sta TCPBEN          
     3 3652 68			            pla                 
     4 3653 8D A1 D5		            sta TCPBRH          
     5 3656 68			            pla                 
     6 3657 8D A0 D5		            sta TCPBRL          
     7 365A 68			            pla                 
     8 365B 8D A7 D5		            sta TCMOFR          
     9 365E 68			            pla                 
    10 365F 8D A6 D5		            sta TCMOSL          
Source: /Users/holgerjanz/Documents/ATARI-XL/Projects/RAMCART/FTe SpartaDOS 3/RAMCART.ASM
   953 3662 A9 E0		            lda #$e0            ; enable interrupts
   954 3664 8D 0E D4		            sta NMIEN
   955 3667 58			            cli
   956 3668 C6 42		            dec CRITIC          ; 54 cycles
   957 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   958 				; set rc            
   959 366A A0 01		RDSIOEND    ldy #$01
   960 366C 2C A0 8B		            bit $8BA0           ; $2c, ldy #$8b; bank/sector number error #139 NAK
   961
   962 366F 8C 03 03					sty DSTATS
   963 3672 98			            tya                 ; set RC
   964 3673 60			            rts
   965 				            
   966 				; drive configuration buffer
   967 3674 28 01 12		CONFBUF     .byte $28,$01,$12
   968 3677 00			L36BB       .byte $00
   969 3678 00 00 00		            .byte $00,$00,$00
   970 367B 80			CONFSECSIZ  .byte $80                   ; $80 -> 128Byte, $00 -> 256Byte
   971 367C FF 00 00 00		            .byte $FF,$00,$00,$00
   972
   973 3680 FF			DRVNUM      .byte $ff
   974 3681 FF			FDRVNUM     .byte $ff
   975 				; $80 for 128Bytes ($100 for 256Bytes)
   976 3682			BUFFERXX1
   977 				;            org $37E6
   978 = 3702			REAEND      = BUFFERXX1 + $80
   979 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   980 				;;; END OF REALLOC BLOCK
   981 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   982
   983
   984 				; $20 Bytes
   985 = 3702			BNKSAVBUF   = REAEND
   986
   987 				; $20 bytes
   988 				;            org $3806
   989 				;BNKSAVBUF2  = BNKSAVBUF + $20
   990
   991 				 
   992 				;           org $3826
   993 3682			            org BNKSAVBUF + $20
   994 				; realloc whole addresses
   995 3722-3836> 98 32		REATAB      .word REAA001+1 ;$33CA
   996 3724 A2 32		            .word REAA002+1 ;$33D4
   997 3726 A9 32		            .word REAA003+1 ;$33DB
   998 3728 CE 34		            .word REAA004+1 ;$3583
   999 372A 9C 35		            .word REAA005+1 ;$364E
  1000 372C 18 36		            .word REAA006+1 ;$367E
  1001 372E 46 36		            .word REAA007+1 ;$369C
  1002 3730 3C 36		            .word REAA008+1 ;$368F
  1003 3732 F2 34		            .word REAA009+1 ;$35A5
  1004 3734 F9 34		            .word REAA010+1 ;$35AC
  1005 3736 13 35		            .word REAA011+1 ;$35C6
  1006 3738 27 35		            .word REAA012+1 ;$35D8
  1007 373A 2E 35		            .word REAA013+1 ;$35DF
  1008 373C 31 35		            .word REAA014+1 ;$35E2
  1009 373E 49 35		            .word REAA015+1 ;$35FA
  1010 3740 4E 35		            .word REAA016+1 ;$35FF
  1011 3742 5F 35		            .word REAA020+1 ;$3610
  1012 3744 83 35		            .word REAA021+1
  1013 3746 86 35		            .word REAA022+1
  1014 3748 8B 35		            .word REAA023+1
  1015 374A 8E 35		            .word REAA024+1
  1016 374C CD 35		            .word REAA025+1
  1017 374E D6 34		            .word REAA026+1
  1018 3750 00 00		            .word $0000
  1019 				 
  1020 				; realloc address low byte           
  1021 3752 7F 32		            .word REAL001+1 ;$33B1
  1022 3754 9B 32		            .word REAL002+1 ;$33CD
  1023 3756 BC 34		            .word REAL003+1 ;$356E
  1024 3758 00 00		            .word $0000
  1025 				; realloc address high byte (address to high byte and value of low byte)
  1026 375A 83 32		            .word REAH001+1  ;$33B5
  1027 375C B8			            .byte <JSRDOSINI ;$6A
  1028 				                        
  1029 375D A5 32		            .word REAH002+1 ;$33D7
  1030 375F C6			            .byte <RAMDSIO  ;$78
  1031 				            
  1032 3760 C1 34		            .word REAH003+1  ;$3573
  1033 3762 02			            .byte <REAEND    ;$E6
  1034 				            
  1035
  1036 3763 00 00		            .word $0000
  1037 				            
  1038 3765 A9 00		REASTART    lda #$00
  1039 3767 8D 37 38		            sta REALOOPCNT
  1040 376A AE 37 38		REALOOP     ldx REALOOPCNT
  1041 376D BD 29 38		            lda REATABADR,X
  1042 3770 8D 0F 38		            sta L3910+1
  1043 3773 BD 2A 38		            lda REATABADR+1,X
  1044 3776 8D 10 38		            sta L3910+2
  1045 3779 0D 0F 38		            ora L3910+1
  1046 377C D0 01		            bne L3881
  1047 377E 60			            rts
  1048 				            
  1049 377F 38			L3881       sec
  1050 3780 BD 2D 38		            lda READSTADR,X
  1051 3783 FD 2B 38		            sbc REASRCADR,X
  1052 3786 8D 38 38		            sta READIFLO
  1053 3789 BD 2E 38		            lda READSTADR+1,X
  1054 378C FD 2C 38		            sbc REASRCADR+1,X
  1055 378F 8D 39 38		            sta READIFHI
  1056 				            
  1057 3792 20 1A 38		L3894       jsr L391C
  1058 3795 F0 13		            beq L38AC
  1059 3797 B1 D7		            lda ($D7),Y
  1060 3799 18			            clc
  1061 379A 6D 38 38		            adc READIFLO
  1062 379D 91 D7		            sta ($D7),Y
  1063 379F C8			            iny
  1064 37A0 B1 D7		            lda ($D7),Y
  1065 37A2 6D 39 38		            adc READIFHI
  1066 37A5 91 D7		            sta ($D7),Y
  1067 37A7 4C 92 37		            jmp L3894
  1068 37AA 20 1A 38		L38AC       jsr L391C
  1069 37AD F0 0B		            beq L38BC
  1070 37AF B1 D7		            lda ($D7),Y
  1071 37B1 18			            clc
  1072 37B2 6D 38 38		            adc READIFLO
  1073 37B5 91 D7		            sta ($D7),Y
  1074 37B7 4C AA 37		            jmp L38AC
  1075 37BA 20 1A 38		L38BC       jsr L391C
  1076 37BD F0 11		            beq L38D2
  1077 37BF 20 0E 38		            jsr L3910
  1078 37C2 18			            clc
  1079 37C3 6D 38 38		            adc READIFLO
  1080 37C6 B1 D7		            lda ($D7),Y
  1081 37C8 6D 39 38		            adc READIFHI
  1082 37CB 91 D7		            sta ($D7),Y
  1083 37CD 4C BA 37		            jmp L38BC
  1084 37D0 AE 37 38		L38D2       ldx REALOOPCNT
  1085
  1086 37D3 BD 2F 38		            lda CPYFROMADR,X
  1087 37D6 8D F1 37		            sta L38F2+1
  1088 37D9 BD 30 38		            lda CPYFROMADR+1,X
  1089 37DC 8D F2 37		            sta L38F2+2
  1090
  1091 37DF BD 33 38		            lda CPYTOADR,X
  1092 37E2 8D F4 37		            sta L38F2+4
  1093 37E5 BD 34 38		            lda CPYTOADR+1,X
  1094 37E8 8D F5 37		            sta L38F2+5
  1095
  1096 37EB BC 32 38		            ldy CPYLENGTH+1,X
  1097 37EE A2 00		            ldx #$00
  1098 37F0 BD FF FF		L38F2       lda $FFFF,X
  1099 37F3 9D FF FF		            sta $FFFF,X
  1100 37F6 E8			            inx
  1101 37F7 D0 F7		            bne L38F2
  1102 37F9 EE F2 37		            inc L38F2+2
  1103 37FC EE F5 37		            inc L38F2+5
  1104 37FF 88			            dey
  1105 3800 10 EE		            bpl L38F2
  1106 3802 AD 37 38		            lda REALOOPCNT
  1107 3805 18			            clc
  1108 3806 69 0C		            adc #$0C
  1109 3808 8D 37 38		            sta REALOOPCNT
  1110 380B 4C 6A 37		            jmp REALOOP
  1111 				            
  1112 380E AD FF FF		L3910       lda $FFFF
  1113 3811 EE 0F 38		            inc L3910+1
  1114 3814 D0 03		            bne L391B
  1115 3816 EE 10 38		            inc L3910+2
  1116 3819 60			L391B       rts
  1117
  1118 381A 20 0E 38		L391C       jsr L3910
  1119 381D 85 D7		            sta $D7
  1120 381F 20 0E 38		            jsr L3910
  1121 3822 A0 00		            ldy #$00
  1122 3824 85 D8		            sta $D8
  1123 3826 05 D7		            ora $D7
  1124 3828 60			            rts
  1125
  1126 				; realloc code pointer
  1127 3829 22 37		REATABADR   .word REATAB
  1128 382B B8 34		REASRCADR   .word REABEGIN
  1129 382D FF FF		READSTADR   .word $FFFF
  1130 				; copy code pointer
  1131 382F B8 34		CPYFROMADR  .word REABEGIN
  1132 3831 4A 02		CPYLENGTH   .word REAEND-REABEGIN ;$027C
  1133 3833 FF FF		CPYTOADR    .word $FFFF
  1134 3835 00 00		            .word $0000
  1135 				            
  1136 				; $01 byte
  1137 3837			REALOOPCNT  ;= $392B
  1138 = 3838			READIFLO   = REALOOPCNT+1
  1139 = 3839			READIFHI   = READIFLO+1
  1140
  1141
  1142 				         
